# 06_ex30.rb - コードエラー解説

## 概要
このファイルは、mboxファイルからメールアドレスと件名を抽出し、フィルタリングして表示するRubyスクリプトです。しかし、現在のコードには4箇所のエラーが含まれています。

---

## エラー箇所の詳細

### ❌ エラー1: 88行目 - 変数名の不一致

```ruby
87:  emails_list = mbox_parser(file_path)
88:  logger.info("Extract #{email_list.size} addresses")  # ❌ 間違い
```

**問題点:**
- 87行目で定義された変数は `emails_list`（複数形）
- 88行目では `email_list`（単数形）を参照している
- この変数は存在しないため、`undefined local variable or method 'email_list'` エラーが発生

**修正方法:**
```ruby
logger.info("Extract #{emails_list.size} addresses")  # ✅ 正しい
```

---

### ❌ エラー2: 96行目 - 変数名にスペースが含まれる

```ruby
96:  logger.info("Filtered to #{filtered list.size} addresses")  # ❌ 間違い
```

**問題点:**
- `filtered list` の間にスペースが入っている
- Rubyの変数名にスペースは使えないため、構文エラーが発生
- さらに、`pattern` が nil の場合、`filtered_list` が定義されないため、`undefined local variable` エラーも発生する可能性あり

**修正方法:**
```ruby
logger.info("Filtered to #{filtered_list.size} addresses")  # ✅ スペースを削除
```

**さらに、patternがnilの場合の対処も必要:**
```ruby
# メソッドチェーンを実装
target_list = if pattern
  filtered = emails_list.select do |email|
    pattern.any? { |p| p.match?(email[:from]) }
  end
  logger.info("Filtered to #{filtered.size} addresses")
  filtered
else
  emails_list
end
```

---

### ❌ エラー3: 98行目 - 未定義の変数 `filter_list`

```ruby
98:  uniq_list = filter_list.uniq.sort  # ❌ 間違い
```

**問題点:**
- `filter_list` という変数は定義されていない
- 52行目の `make_pattern` 関数内にローカル変数として `filter_list` が存在するが、スコープ外
- さらに、`emails_list` や `filtered_list` はハッシュの配列 `[{from: "addr", subject: "subj"}, ...]` なので、直接 `.uniq.sort` できない

**修正方法:**
```ruby
# ハッシュの配列からアドレスだけを取り出す
target_list = pattern ? filtered_list : emails_list
uniq_list = target_list.map { |email| email[:from] }.uniq.sort  # ✅ 正しい
```

**解説:**
1. `target_list.map { |email| email[:from] }` でハッシュからアドレス文字列だけを抽出
2. `.uniq` で重複を削除
3. `.sort` でアルファベット順にソート

---

### ❌ エラー4: 106行目 - 代入演算子と比較演算子の混同

```ruby
106:  if __FILE__ = $0  # ❌ 間違い（代入演算子）
```

**問題点:**
- `=` は代入演算子
- ここでは `__FILE__` と `$0` が同じかどうかを比較したい
- 代入演算子を使うと、`$0` の値を `__FILE__` に代入しようとして、エラーまたは意図しない動作が発生

**修正方法:**
```ruby
if __FILE__ == $0  # ✅ 正しい（比較演算子）
```

**補足:**
- `__FILE__`: 現在実行中のファイルのパス
- `$0`: Rubyインタプリタに渡されたスクリプトファイル名
- この条件式は「このファイルが直接実行された場合のみ `main()` を呼ぶ」という意味

---

## 完全な修正版コード（90-107行目）

```ruby
# メソッドチェーンを実装
target_list = if pattern
  filtered = emails_list.select do |email|
    pattern.any? { |p| p.match?(email[:from]) }
  end
  logger.info("Filtered to #{filtered.size} addresses")
  filtered
else
  emails_list
end

uniq_list = target_list.map { |email| email[:from] }.uniq.sort
logger.info("Removed duplicate, #{uniq_list.size} unique addresses")
logger.info("Sorted alphabetically")

logger.info("Result:")
uniq_list.each { |sender| logger.info(sender) }
end

if __FILE__ == $0
  main()
end
```

---

## 実行時に発生したエラー

### ❌ エラー5: 59行目 - `end` の閉じ忘れによる構文エラー

**エラーメッセージ:**
```
Unmatched keyword, missing `end' ?
  52  def make_pattern(raw_filter)
> 56    begin
> 57      filter_list.each do |filter|
> 63    end
  66  end

./06_ex30.rb:112: syntax error, unexpected end-of-input (SyntaxError)
```

**問題のコード:**
```ruby
56→  begin
57→    filter_list.each do |filter|
58→      safe_filter = Regexp.escape(filter)
59→      pattern << Regexp.new(safe_filter, Regexp::IGNORECASE)
    # ← ここに end が必要！
60→  rescue RegexpError => e
61→    logger.error("make_pattern: Invalid filter")
62→    logger.error(e.full_message)
63→  end
```

**問題点:**
- 57行目の `filter_list.each do |filter|` ブロックに対応する `end` が存在しない
- そのため、60行目の `rescue` が構文エラーとなる
- `begin...rescue...end` 構造の前に、`each do...end` ブロックを閉じる必要がある

**修正方法:**
```ruby
56→  begin
57→    filter_list.each do |filter|
58→      safe_filter = Regexp.escape(filter)
59→      pattern << Regexp.new(safe_filter, Regexp::IGNORECASE)
60→    end  # ← each ブロックを閉じる
61→  rescue RegexpError => e
62→    logger.error("make_pattern: Invalid filter")
63→    logger.error(e.full_message)
64→  end
```

---

### ❌ エラー6: 89行目 - logger のスコープエラー

**エラーメッセージ:**
```
./06_ex30.rb:89:in `main': undefined local variable or method `logger' for main:Object (NameError)

  logger.info("Extract #{emails_list.size} addresses")
  ^^^^^^
        from ./06_ex30.rb:112:in `<main>'
```

**問題のコード:**
```ruby
11→logger = Logger.new(STDERR)
12→logger.level = Logger::DEBUG
...
69→def main()
  ...
88→  logger.info("Extract #{emails_list.size} addresses")  # ❌ エラー
```

**問題点:**
- Rubyでは、トップレベルで定義された変数（小文字で始まる）はローカル変数として扱われる
- メソッド内からはトップレベルのローカル変数にアクセスできない
- そのため、`main` 関数内や `make_pattern` 関数内で `logger` を参照するとエラーが発生

**修正方法1: 定数にする（推奨）**
```ruby
LOGGER = Logger.new(STDERR)  # 定数（大文字で開始）
LOGGER.level = Logger::DEBUG
```

そして、すべての `logger` を `LOGGER` に置き換える（約10箇所）：
- 62行目: `LOGGER.error("make_pattern: Invalid filter")`
- 63行目: `LOGGER.error(e.full_message)`
- 71-72行目、78行目、88行目、95行目、102-103行目、106-107行目

**修正方法2: main関数内で定義する**
```ruby
def main()
  logger = Logger.new(STDERR)
  logger.level = Logger::DEBUG

  unless 1 <= ARGV.length
    logger.error("Usage: ./[This file] [.mbox] [filter option]")
    ...
```

ただし、この場合は `make_pattern` 関数にも logger を引数として渡す必要がある：
```ruby
pattern = make_pattern(filter_raw, logger)

def make_pattern(raw_filter, logger)
  ...
end
```

---

## その他の改善提案

### 1. logger のスコープ問題
現在、`logger` はグローバル変数として定義されていますが、`make_pattern` 関数内（61-62行目）で使用されています。関数内から参照できないため、エラーが発生する可能性があります。

**修正案:**
- `logger` を定数にする: `LOGGER = Logger.new(STDERR)`
- または、logger を引数として渡す: `make_pattern(filter_raw, logger)`

### 2. 例外処理の改善（60-63行目）
現在の例外処理では `logger.error(e.full_message)` を使用していますが、例外が発生した場合もループが続行されます。

```ruby
rescue RegexpError => e
  logger.error("make_pattern: Invalid filter - #{e.message}")
  logger.error(e.full_message)
  exit -1  # プログラムを終了する場合
end
```

---

## まとめ

| 行番号 | エラーの種類 | 修正内容 |
|--------|------------|---------|
| 88 | 変数名の不一致 | `email_list` → `emails_list` |
| 96 | 変数名のスペース + 未定義 | `filtered list` → `filtered_list` + nilチェック |
| 98 | 未定義変数 + 型の不一致 | `filter_list` → `.map { |e| e[:from] }` で変換 |
| 106 | 演算子の誤り | `=` → `==` |

これらを修正することで、コードは正常に動作するようになります。
