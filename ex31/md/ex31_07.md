# ex31_07 バグ解説

## バグ1: ファイルが flush される前に読み込んでいる

### 問題のコード (`ex31_07.py` L29-34)

```python
with tempfile.NamedTemporaryFile(delete=False, suffix=".mbox") as tmp:
    tmp.write(await file.read())  # ← Python の内部バッファに書き込む
    tmp_path = tmp.name
    result = mbox_main(tmp_path)  # ← まだ OS に書き出されていない可能性
```

### 何が起きているか

`tmp.write()` はすぐにディスクに書き込むのではなく、**Python の内部バッファ**に溜める。
バッファの中身が実際にディスクに書き出される（flush）のは、以下のタイミング：

- `tmp.flush()` を明示的に呼んだとき
- `with` ブロックを抜けて、ファイルが `close()` されたとき

`mbox_main(tmp_path)` は `with` ブロックの**中**で呼んでいるため、
`mailbox.mbox(mail_data)` が一時ファイルを開いたとき、中身が空または不完全なことがある。

### 修正方法

`with` ブロックを抜けてから `mbox_main` を呼ぶ。
ブロックを抜けると `close()` が呼ばれ、バッファが確実に flush される。

```python
with tempfile.NamedTemporaryFile(delete=False, suffix=".mbox") as tmp:
    tmp.write(await file.read())
    tmp_path = tmp.name
# ← ここで close() → flush() が実行される

result = mbox_main(tmp_path)
json_result = create_json(result)
back_task.add_task(cleanup, tmp_path)
return json_result
```

---

## バグ2: グローバル変数 `domain_dict` がリクエスト間で蓄積される

### 問題のコード (`mbox.py` L16, L129-130)

```python
# モジュールトップレベルで定義
domain_dict = {}

def mbox_main(mail_data):
    ...
    for mail in mbox:
        if domain not in domain_dict:
            domain_dict[domain] = DomainData()  # グローバルに追加していく
```

### 何が起きているか

`domain_dict` はモジュールが import されたタイミングで1回だけ `{}` で初期化される。
FastAPI のサーバーが動いている間、モジュールは1度しか import されない。

そのため：

| リクエスト | 状態 |
|---|---|
| 1回目 | `domain_dict` は空 → 正常に集計 |
| 2回目 | `domain_dict` に1回目の結果が残ったまま集計 → 結果が混ざる |
| 3回目以降 | どんどん蓄積される |

### 修正方法

`domain_dict` を `mbox_main` のローカル変数にする。
関数が呼ばれるたびに新しい `{}` で初期化される。

```python
def mbox_main(mail_data):
    domain_dict = {}  # ← ローカル変数にする
    ...
```
